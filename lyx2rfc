#!/bin/ksh

# Copyright (c) 2012, Cryptonector, LLC.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
# - Redistributions of source code must retain the above copyright
#   notice, this list of conditions and the following disclaimer.
#
# - Redistributions in binary form must reproduce the above copyright
#   notice, this list of conditions and the following disclaimer in
#   the documentation and/or other materials provided with the
#   distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
# FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
# COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
# INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
# STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
# OF THE POSSIBILITY OF SUCH DAMAGE.

set -e
set -o noglob

PROG=${0##*/}
if [[ "$0" = */* ]]; then
    ORIGIN=${0%/*}
    if [[ "$ORIGIN" != /* ]]; then
        ORIGIN=${PWD}/$ORIGIN
    fi
else
    ORIGIN=${PWD}
fi
XSL=$ORIGIN/lyxhtml2xml2rfc.xsl

LYX_XHTML_DTD=http://www.w3.org/TR/MathML2/dtd/xhtml-math11-f.dtd
XHTML_DTD=http://www.w3.org/TR/2001/REC-MathML2-20010221/dtd/xhtml-math11-f.dtd
LOCAL_XHTML_DTD=$ORIGIN/xhtml-math11-f.dtd

function usage {
    printf "Usage: $PROG lyx_file [out_file]\n"
    exit 1
}

# Very, very lame command-line parsing (should use getopts).
#
# The first argument must be a LyX document filename.  If it doesn't end
# in .lyx we'll tack on the .lyx extension.
#
# The second argument must be an output filename.  The extension must be
# one of txt, pdf, html, or xml.  If no extension is provided we'll tack
# on '.txt'.
(($# > 0)) || usage
(($# < 3)) || usage
lyxf=$1
[[ "$lyxf" != *.lyx && "$lyxf" != *.* ]] && lyxf=${lyxf}.lyx
[[ "$lyxf" != *.lyx ]] && usage
xhtml=${1:%.lyx}.xhtml
out=${2:-${lyxf%.lyx}.txt}
unpg=${2:-${lyxf%.lyx}.unpg}
[[ "$out" != *.* ]] && out=${out}.txt
[[ "$out" != *.@(txt|pdf|html|xml) ]] && usage
xmlout=${out%.@(txt|pdf|html|xml)}.xml
htmlout=${out%.@(txt|pdf|html|xml)}.html

# Get and cache a local copy of the XHTML DTD:
if [[ ! -f "$LOCAL_XHTML_DTD" ]]; then
    wget $XHTML_DTD
fi

# Export LyX document as XHTML:
printf "Exporting LyX document as XHTML...\n"
lyx -e xhtml "$lyxf"

# Fix DTD URL in XHTML to refer to the local copy (LyX uses a dead URL):
sed --in-place -e "s,${LYX_XHTML_DTD},file://${LOCAL_XHTML_DTD}," "$xhtml"

# Apply the lyx2rfc XSTL stylesheet and pretty-print result:
# (the old xml2rfc tool doesn't grok xmlns attributes; remove them)
printf "Applying XSLT stylesheet for XHTML->rfc2629.dtd conversion...\n"
java net/sf/saxon/Transform "$xhtml" $XSL | 
    sed -e 's,xmlns="xml2rfc",,' -e 's/></>\n</g' |
    xmllint --format - > "$xmlout"

# Set the correct DTD URL, just so we don't have a local path left here
sed --in-place -e "s,file://${LOCAL_XHTML_DTD},${XHTML_DTD}," "$xhtml"

# Run xml2rfc to do the final conversion if desired:
printf "Applying xml2rfc for final paginated formatting...\n"
[[ "$out" != *.xml ]] && DISPLAY= xml2rfc "$xmlout" "$out"

printf "Applying xml2rfc for final unpaginated formatting...\n"
[[ "$out" != *.xml ]] && DISPLAY= xml2rfc "$xmlout" "$unpg"

# Use Greenbytes' XSLT to produce HTML
printf "Applying the Julian Reschke's (Greenbytes) XSLT to produce HTML...\n"
java net/sf/saxon/Transform  "$xmlout" rfc2629.xslt > "$htmlout"
